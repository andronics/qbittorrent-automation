# qBittorrent Automation - Rules Configuration
#
# Rules define conditions and actions to automate torrent management.
# All field references use dot notation with API prefix: info.*, trackers.*, files.*, etc.
#
# For settings, see config.yml

# Optional: Reusable references (v0.5.0+)
# Define reusable variables, conditions, and actions to reduce repetition.
# Use ${vars.name} for variable substitution and $ref: path for structure expansion.
#
# Uncomment and customize the refs block below to use the resolver layer:

# refs:
#   vars:
#     # Scalar values - thresholds, patterns, lists
#     min_ratio: 1.0
#     high_ratio: 2.5
#     cleanup_age: "30 days"
#     private_ratio_threshold: 1.0
#     hd_pattern: '(?i).*(1080p|2160p|4k).*'
#     protected_categories: ["keep", "seedbox", "archive"]
#
#   conditions:
#     # Reusable condition groups
#     private-tracker:
#       any:
#         - field: trackers.url
#           operator: contains
#           value: ".private"
#         - field: trackers.url
#           operator: contains
#           value: "privatehd.to"
#
#     well-seeded:
#       all:
#         - field: info.ratio
#           operator: ">="
#           value: ${vars.min_ratio}
#         - field: info.completion_on
#           operator: older_than
#           value: ${vars.cleanup_age}
#
#     hd-content:
#       all:
#         - field: info.name
#           operator: matches
#           value: ${vars.hd_pattern}
#
#     protected:
#       any:
#         - field: info.category
#           operator: in
#           value: ${vars.protected_categories}
#         - field: info.tags
#           operator: contains
#           value: "keep"
#
#   actions:
#     # Reusable action sequences
#     safe-delete:
#       - type: add_tag
#         params:
#           tags: ["pending-delete"]
#       - type: stop
#
#     force-seed:
#       - type: force_start
#       - type: add_tag
#         params:
#           tags: ["force-seeding"]
#
#     tag-hd:
#       - type: add_tag
#         params:
#           tags: ["hd", "auto-tagged"]

# Example rules using refs (uncomment to enable):
# - name: "Cleanup well-seeded private tracker torrents"
#   enabled: true
#   conditions:
#     - $ref: conditions.private-tracker
#     - $ref: conditions.well-seeded
#     - none:
#         - $ref: conditions.protected
#   actions:
#     - $ref: actions.safe-delete
#
# - name: "Force seed private tracker under ratio"
#   enabled: true
#   conditions:
#     - $ref: conditions.private-tracker
#     - all:
#         - field: info.ratio
#           operator: "<"
#           value: ${vars.private_ratio_threshold}
#   actions:
#     - $ref: actions.force-seed

rules:
  - name: Block unwanted archive files on add
    enabled: true
    stop_on_match: true  # Don't process other rules if matched
    context: torrent-imported  # Context can be any custom string you define
    conditions:
      any:
        - field: files.name
          operator: matches
          value: '(?i)\.(rar|zip|7z|tar|gz|bz2|xz)$'
    actions:
      - type: add_tag
        params:
          tags:
            - blocked-archive
            - auto-filtered
      - type: stop
      # Uncomment to auto-delete instead of stop:
      # - type: delete_torrent
      #   params:
      #     keep_files: false

  - name: Tag private tracker torrents
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: trackers.url
          operator: contains
          value: .private
    actions:
      - type: add_tag
        params:
          tags:
            - private

  - name: Auto-categorize HD movies
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.name
          operator: matches
          value: (?i).*(1080p|2160p|4k).*
        - field: info.category
          operator: ==
          value: ''
    actions:
      - type: set_category
        params:
          category: movies-hd
      - type: add_tag
        params:
          tags:
            - hd
            - auto-categorized

  - name: Auto-categorize TV shows
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.name
          operator: matches
          value: '(?i).*(s\d{2}e\d{2}|season).*'
        - field: info.category
          operator: ==
          value: ''
    actions:
      - type: set_category
        params:
          category: tv

  - name: Remove torrents with all dead trackers
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.added_on
          operator: older_than
          value: 14 days
        - field: trackers.status
          operator: in
          value:
            - 0
            - 4
    actions:
      - type: delete_torrent
        params:
          keep_files: true

  - name: Remove stalled magnet links
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.state
          operator: ==
          value: metaDL
        - field: info.added_on
          operator: older_than
          value: 7 days
    actions:
      - type: delete_torrent
        params:
          keep_files: false

  - name: Pause well-seeded torrents
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.ratio
          operator: '>='
          value: 2
        - field: info.seeding_time
          operator: '>'
          value: 604800  # 168 hours in seconds
        - field: info.num_leechs
          operator: ==
          value: 0
      none:
        - field: info.category
          operator: in
          value:
            - seedbox
            - long-term
    actions:
      - type: stop
      - type: add_tag
        params:
          tags:
            - auto-stopped
            - seeded

  - name: Force start private tracker torrents under ratio
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.ratio
          operator: <
          value: 1
        - field: info.state
          operator: in
          value:
            - stalledUP
            - queuedUP
        - field: trackers.url
          operator: contains
          value: .private
    actions:
      - type: force_start
      - type: add_tag
        params:
          tags:
            - private-seeding

  - name: Delete old completed torrents
    enabled: true
    stop_on_match: true
    conditions:
      all:
        - field: info.completion_on
          operator: older_than
          value: 30 days
        - field: info.ratio
          operator: '>='
          value: 1
      none:
        - field: info.category
          operator: in
          value:
            - seedbox
            - keep
    actions:
      - type: delete_torrent
        params:
          keep_files: false

  - name: Emergency space cleanup
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: info.ratio
          operator: '>='
          value: 0.5
        - field: info.completion_on
          operator: older_than
          value: 3 days
    actions:
      - type: delete_torrent
        params:
          keep_files: false

  - name: Remove errored torrents
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.state
          operator: ==
          value: error
    actions:
      - type: delete_torrent
        params:
          keep_files: true

  - name: Remove missing files torrents
    enabled: true
    stop_on_match: false
    conditions:
      all:
        - field: info.state
          operator: ==
          value: missingFiles
        - field: info.added_on
          operator: older_than
          value: 1 day
    actions:
      - type: delete_torrent
        params:
          keep_files: false

  - name: Tag torrents from specific tracker
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: trackers.url
          operator: matches
          value: '^https://tracker\.example\.com.*'
    actions:
      - type: add_tag
        params:
          tags:
            - tracker-example

  - name: Pause torrents with no seeders
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: info.state
          operator: ==
          value: stalledDL
        - field: info.added_on
          operator: older_than
          value: 3 days
        - field: trackers.num_seeds
          operator: ==
          value: 0
    actions:
      - type: stop
      - type: add_tag
        params:
          tags:
            - no-seeds

  - name: Limit upload speed for old torrents
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: info.ratio
          operator: '>='
          value: 5
        - field: info.seeding_time
          operator: '>'
          value: 2592000  # 720 hours in seconds
    actions:
      - type: set_upload_limit
        params:
          limit: 102400

  - name: Tag torrents when encryption is required
    enabled: false
    stop_on_match: false
    context: torrent-imported  # Context can be any custom string you define
    conditions:
      all:
        - field: app.encryption
          operator: ==
          value: 2  # 2 = require encrypted connections
    actions:
      - type: add_tag
        params:
          tags:
            - encrypted-only

  - name: Tag HD content from private trackers
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: info.name
          operator: matches
          value: (?i).*(1080p|2160p).*
        - field: info.size
          operator: '>'
          value: 10737418240
        - field: trackers.url
          operator: contains
          value: .private
    actions:
      - type: add_tag
        params:
          tags:
            - hd
            - private
            - large
      - type: set_category
        params:
          category: private-hd

  - name: Recheck stalled downloads
    enabled: false
    stop_on_match: false
    conditions:
      all:
        - field: info.state
          operator: ==
          value: stalledDL
        - field: info.progress
          operator: '>'
          value: 0.9
        - field: info.last_activity
          operator: older_than
          value: 12 hours
    actions:
      - type: recheck
