name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package with dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          echo "✓ Package and dependencies installed"

      - name: Validate Python syntax
        run: |
          python -m py_compile src/qbt_rules/*.py
          python -m py_compile src/qbt_rules/cli/*.py
          python -m py_compile triggers/*.py
          echo "✓ All Python files have valid syntax"

      - name: Test module imports
        run: |
          python -c "from qbt_rules.api import QBittorrentAPI; print('✓ qbt_rules.api')"
          python -c "from qbt_rules.config import load_config; print('✓ qbt_rules.config')"
          python -c "from qbt_rules.engine import RulesEngine; print('✓ qbt_rules.engine')"
          python -c "from qbt_rules.errors import *; print('✓ qbt_rules.errors')"
          python -c "from qbt_rules.utils import *; print('✓ qbt_rules.utils')"
          python -c "from qbt_rules.logging import setup_logging; print('✓ qbt_rules.logging')"
          python -c "from qbt_rules.arguments import create_parser; print('✓ qbt_rules.arguments')"
          python -c "from qbt_rules.cli.manual import main; print('✓ qbt_rules.cli.manual')"
          echo "✓ All modules import successfully"

      - name: Run tests
        run: |
          pytest tests/ -v --cov=qbt_rules --cov-report=term-missing
          echo "✓ All tests passed"

      - name: Lint with ruff
        continue-on-error: true
        run: |
          ruff check src/ triggers/ || echo "Linting issues found (non-blocking)"

      - name: Check code formatting
        continue-on-error: true
        run: |
          black --check src/ triggers/ || echo "Formatting issues found (non-blocking)"

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy src/qbt_rules --ignore-missing-imports || echo "Type issues found (non-blocking)"

      - name: Verify version file
        run: |
          python -c "from qbt_rules.__version__ import __version__; print(f'Version: {__version__}')"
          echo "✓ Version file is valid"

      - name: Check for common issues
        run: |
          # Check for print statements (should use logger)
          if grep -r "print(" src/ triggers/ --include="*.py" | grep -v "# print OK" | grep -v "__pycache__"; then
            echo "Warning: Found print() statements. Consider using logger instead."
          fi

          # Check for hardcoded credentials
          if grep -rE "(password|token|secret|key)\s*=\s*['\"][^'\"]{8,}" src/ triggers/ --include="*.py" | grep -v "password ="; then
            echo "Warning: Potential hardcoded credentials found!"
            exit 1
          fi

          echo "✓ No common issues found"

      - name: Validate configuration examples
        run: |
          python -c "import yaml; yaml.safe_load(open('config/config.example.yml'))"
          python -c "import yaml; yaml.safe_load(open('config/rules.example.yml'))"
          echo "✓ Configuration examples are valid YAML"

  validate-version:
    name: Validate Version Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Check version format
        run: |
          VERSION=$(python -c "from qbt_rules.__version__ import __version__; print(__version__)")
          echo "Current version: $VERSION"

          # Validate semver format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Version must follow semantic versioning (1.2.3 or 1.2.3-beta.1)"
            exit 1
          fi

          echo "✓ Version format is valid"
