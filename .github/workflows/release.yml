name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write  # Required for Docker image publishing

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Validate PEP 440 compatible version format
          # Supports: v1.2.3, v1.2.3a1, v1.2.3b2, v1.2.3rc1, v1.2.3.post1, v1.2.3.dev0
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(a[0-9]+|b[0-9]+|rc[0-9]+)?(\.post[0-9]+)?(\.dev[0-9]+)?$'; then
            echo "Error: Tag must follow PEP 440 versioning (v1.2.3, v1.2.3rc1, v1.2.3a1, etc.)"
            exit 1
          fi

          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $TAG ($VERSION)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update version in code
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update __version__.py
          sed -i "s/__version__ = .*/__version__ = \"$VERSION\"/" src/qbt_rules/__version__.py
          echo "Updated src/qbt_rules/__version__.py to version $VERSION"
          cat src/qbt_rules/__version__.py

          # Update pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          echo "Updated pyproject.toml to version $VERSION"
          grep "^version = " pyproject.toml

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          echo "‚úì Package installed successfully"

      - name: Test imports
        run: |
          python -c "from qbt_rules.api import QBittorrentAPI; print('‚úì qbt_rules.api imports successfully')"
          python -c "from qbt_rules.config import load_config; print('‚úì qbt_rules.config imports successfully')"
          python -c "from qbt_rules.engine import RulesEngine; print('‚úì qbt_rules.engine imports successfully')"
          echo "‚úì All critical imports successful"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sed -n '2p')

          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            CHANGELOG="## First Release

            This is the initial release of qbt-rules."
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.tag }}"

            # Generate changelog from commits
            CHANGELOG="## Changes since $PREV_TAG"$'\n\n'

            # Group commits by type
            FEATURES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^feat" | head -20)
            FIXES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^fix" | head -20)
            REFACTORS=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^refactor" | head -20)
            CHORES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^chore" | head -20)

            if [ -n "$FEATURES" ]; then
              CHANGELOG="${CHANGELOG}### ‚ú® New Features"$'\n'"$FEATURES"$'\n\n'
            fi

            if [ -n "$FIXES" ]; then
              CHANGELOG="${CHANGELOG}### üêõ Bug Fixes"$'\n'"$FIXES"$'\n\n'
            fi

            if [ -n "$REFACTORS" ]; then
              CHANGELOG="${CHANGELOG}### ‚ôªÔ∏è Refactoring"$'\n'"$REFACTORS"$'\n\n'
            fi

            if [ -n "$CHORES" ]; then
              CHANGELOG="${CHANGELOG}### üîß Maintenance"$'\n'"$CHORES"$'\n\n'
            fi
          fi

          # Save to file
          echo "$CHANGELOG" > release-notes.md
          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'a') || contains(steps.version.outputs.tag, 'b') || contains(steps.version.outputs.tag, 'rc') }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version update
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet src/qbt_rules/__version__.py pyproject.toml; then
            echo "No version changes to commit"
          else
            git add src/qbt_rules/__version__.py pyproject.toml
            git commit -m "chore: Bump version to ${{ steps.version.outputs.version }}"
            git push origin HEAD:main || echo "Could not push to main (might be protected)"
          fi

      - name: Release summary
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.tag }} created successfully"
          echo ""
          echo "üê≥ Docker images will be built and published automatically by docker-build.yml workflow"
          echo "   Image: ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}"
          echo "   Image: ghcr.io/${{ github.repository }}:latest"
          echo ""
          echo "üì¶ Distribution: Docker-only (v0.4.0+)"
          echo "   Previous PyPI packages (v0.3.x) remain available but are deprecated"
