name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write  # Required for PyPI Trusted Publishing

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Validate PEP 440 compatible version format
          # Supports: v1.2.3, v1.2.3a1, v1.2.3b2, v1.2.3rc1, v1.2.3.post1, v1.2.3.dev0
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(a[0-9]+|b[0-9]+|rc[0-9]+)?(\.post[0-9]+)?(\.dev[0-9]+)?$'; then
            echo "Error: Tag must follow PEP 440 versioning (v1.2.3, v1.2.3rc1, v1.2.3a1, etc.)"
            exit 1
          fi

          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $TAG ($VERSION)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update version in code
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update __version__.py
          sed -i "s/__version__ = .*/__version__ = \"$VERSION\"/" src/qbt_rules/__version__.py
          echo "Updated src/qbt_rules/__version__.py to version $VERSION"
          cat src/qbt_rules/__version__.py

          # Update pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          echo "Updated pyproject.toml to version $VERSION"
          grep "^version = " pyproject.toml

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          echo "âœ“ Package installed successfully"

      - name: Test imports
        run: |
          python -c "from qbt_rules.api import QBittorrentAPI; print('âœ“ qbt_rules.api imports successfully')"
          python -c "from qbt_rules.config import load_config; print('âœ“ qbt_rules.config imports successfully')"
          python -c "from qbt_rules.engine import RulesEngine; print('âœ“ qbt_rules.engine imports successfully')"
          echo "âœ“ All critical imports successful"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sed -n '2p')

          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            CHANGELOG="## First Release

            This is the initial release of qbt-rules."
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.tag }}"

            # Generate changelog from commits
            CHANGELOG="## Changes since $PREV_TAG"$'\n\n'

            # Group commits by type
            FEATURES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^feat" | head -20)
            FIXES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^fix" | head -20)
            REFACTORS=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^refactor" | head -20)
            CHORES=$(git log $PREV_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s" --grep="^chore" | head -20)

            if [ -n "$FEATURES" ]; then
              CHANGELOG="${CHANGELOG}### âœ¨ New Features"$'\n'"$FEATURES"$'\n\n'
            fi

            if [ -n "$FIXES" ]; then
              CHANGELOG="${CHANGELOG}### ðŸ› Bug Fixes"$'\n'"$FIXES"$'\n\n'
            fi

            if [ -n "$REFACTORS" ]; then
              CHANGELOG="${CHANGELOG}### â™»ï¸ Refactoring"$'\n'"$REFACTORS"$'\n\n'
            fi

            if [ -n "$CHORES" ]; then
              CHANGELOG="${CHANGELOG}### ðŸ”§ Maintenance"$'\n'"$CHORES"$'\n\n'
            fi
          fi

          # Save to file
          echo "$CHANGELOG" > release-notes.md
          cat release-notes.md

      - name: Create release archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE="qbt-rules-v${VERSION}.zip"

          # Create archive with source, configs, docs
          zip -r "$ARCHIVE" \
            src/ \
            triggers/ \
            config/*.example.yml \
            pyproject.toml \
            README.md \
            LICENSE \
            .gitignore \
            -x "**/__pycache__/*" "**/*.pyc"

          echo "Created $ARCHIVE"
          ls -lh "$ARCHIVE"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: release-notes.md
          files: |
            qbt-rules-v${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'a') || contains(steps.version.outputs.tag, 'b') || contains(steps.version.outputs.tag, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version update
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet src/qbt_rules/__version__.py pyproject.toml; then
            echo "No version changes to commit"
          else
            git add src/qbt_rules/__version__.py pyproject.toml
            git commit -m "chore: Bump version to ${{ steps.version.outputs.version }}"
            git push origin HEAD:main || echo "Could not push to main (might be protected)"
          fi

  build:
    name: Build Distribution Packages
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Use main branch which has the updated version from release job

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          echo "âœ“ Build tools installed"

      - name: Build distribution packages
        run: |
          python -m build
          echo "âœ“ Distribution packages built"
          ls -lh dist/

      - name: Verify distributions
        run: |
          twine check dist/*
          echo "âœ“ Distribution packages verified"

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  test-publish:
    name: Publish to TestPyPI
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    environment:
      name: testpypi
      url: https://test.pypi.org/project/qbt-rules/

    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          print-hash: true

  publish:
    name: Publish to PyPI
    needs: [build, test-publish]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    environment:
      name: pypi
      url: https://pypi.org/project/qbt-rules/

    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          attestations: true
