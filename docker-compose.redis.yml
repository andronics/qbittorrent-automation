version: '3.8'

# qbt-rules - Full Stack with Redis
# Redis queue backend for high-performance job processing
# Suitable for high-volume webhook environments

services:
  qbt-rules:
    image: ghcr.io/andronics/qbt-rules:latest
    container_name: qbt-rules
    restart: unless-stopped

    ports:
      - "5000:5000"  # API server

    volumes:
      # Configuration only (queue stored in Redis)
      - ./config:/config

      # Optional: Docker secrets
      # - ./secrets/qbt_password:/run/secrets/qbt_password:ro
      # - ./secrets/api_key:/run/secrets/api_key:ro
      # - ./secrets/redis_password:/run/secrets/redis_password:ro

    environment:
      # Server configuration
      QBT_RULES_SERVER_HOST: "0.0.0.0"
      QBT_RULES_SERVER_PORT: "5000"
      QBT_RULES_SERVER_API_KEY: "your-secure-api-key-here"  # Change this!
      QBT_RULES_SERVER_WORKERS: "1"

      # Queue configuration (Redis)
      QBT_RULES_QUEUE_BACKEND: "redis"
      QBT_RULES_QUEUE_REDIS_URL: "redis://redis:6379/0"
      # With password: "redis://:password@redis:6379/0"
      # With secrets: QBT_RULES_QUEUE_REDIS_PASSWORD_FILE: "/run/secrets/redis_password"
      QBT_RULES_QUEUE_CLEANUP_AFTER: "7d"

      # qBittorrent connection
      QBT_RULES_QBITTORRENT_HOST: "http://qbittorrent:8080"  # Change to your qBittorrent host
      QBT_RULES_QBITTORRENT_USERNAME: "admin"
      QBT_RULES_QBITTORRENT_PASSWORD: "adminpass"

      # Optional: Use Docker secrets
      # QBT_RULES_QBITTORRENT_PASSWORD_FILE: "/run/secrets/qbt_password"
      # QBT_RULES_SERVER_API_KEY_FILE: "/run/secrets/api_key"

      # Logging
      LOG_LEVEL: "INFO"

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - qbt-network

  redis:
    image: redis:7-alpine
    container_name: qbt-rules-redis
    restart: unless-stopped

    command: redis-server --appendonly yes --appendfsync everysec

    volumes:
      # Persist Redis data (optional, queue is ephemeral by design)
      - redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    networks:
      - qbt-network

    # Optional: Expose Redis port (not recommended for production)
    # ports:
    #   - "6379:6379"

    # Optional: Redis password (recommended)
    # command: redis-server --appendonly yes --requirepass your-redis-password

networks:
  qbt-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
