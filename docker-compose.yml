version: '3.8'

# qbt-rules - Minimal Setup
# SQLite queue (default), single container deployment
# Suitable for home users and small deployments

services:
  qbt-rules:
    image: ghcr.io/andronics/qbt-rules:latest
    container_name: qbt-rules
    restart: unless-stopped

    ports:
      - "5000:5000"  # API server

    volumes:
      # Configuration and database
      - ./config:/config

      # Optional: Docker secrets (recommended)
      # - ./secrets/qbt_password:/run/secrets/qbt_password:ro
      # - ./secrets/api_key:/run/secrets/api_key:ro

    environment:
      # Server configuration
      QBT_RULES_SERVER_HOST: "0.0.0.0"
      QBT_RULES_SERVER_PORT: "5000"
      QBT_RULES_SERVER_API_KEY: "your-secure-api-key-here"  # Change this!
      QBT_RULES_SERVER_WORKERS: "1"

      # Queue configuration (SQLite default)
      QBT_RULES_QUEUE_BACKEND: "sqlite"
      QBT_RULES_QUEUE_SQLITE_PATH: "/config/qbt-rules.db"
      QBT_RULES_QUEUE_CLEANUP_AFTER: "7d"

      # qBittorrent connection
      QBT_RULES_QBITTORRENT_HOST: "http://qbittorrent:8080"  # Change to your qBittorrent host
      QBT_RULES_QBITTORRENT_USERNAME: "admin"
      QBT_RULES_QBITTORRENT_PASSWORD: "adminpass"

      # Optional: Use Docker secrets instead
      # QBT_RULES_QBITTORRENT_PASSWORD_FILE: "/run/secrets/qbt_password"
      # QBT_RULES_SERVER_API_KEY_FILE: "/run/secrets/api_key"

      # Logging
      LOG_LEVEL: "INFO"
      # TRACE_MODE: "true"  # Uncomment for detailed debugging

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Optional: Network configuration
    # networks:
    #   - qbt-network

# Optional: Define network
# networks:
#   qbt-network:
#     driver: bridge
