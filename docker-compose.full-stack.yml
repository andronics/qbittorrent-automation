version: '3.8'

# qbt-rules - Complete Stack Example
# Includes qBittorrent + qbt-rules + Redis
# Complete demonstration setup

services:
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped

    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - WEBUI_PORT=8080

    volumes:
      - ./qbittorrent/config:/config
      - ./qbittorrent/downloads:/downloads

    ports:
      - "8080:8080"  # WebUI
      - "6881:6881"  # Torrent port
      - "6881:6881/udp"

    networks:
      - qbt-network

  qbt-rules:
    image: ghcr.io/andronics/qbt-rules:latest
    container_name: qbt-rules
    restart: unless-stopped

    ports:
      - "5000:5000"  # API server

    volumes:
      - ./qbt-rules/config:/config

    environment:
      # Server configuration
      QBT_RULES_SERVER_HOST: "0.0.0.0"
      QBT_RULES_SERVER_PORT: "5000"
      QBT_RULES_SERVER_API_KEY: "your-secure-api-key-here"
      QBT_RULES_SERVER_WORKERS: "1"

      # Queue configuration (Redis)
      QBT_RULES_QUEUE_BACKEND: "redis"
      QBT_RULES_QUEUE_REDIS_URL: "redis://redis:6379/0"
      QBT_RULES_QUEUE_CLEANUP_AFTER: "7d"

      # qBittorrent connection
      QBT_RULES_QBITTORRENT_HOST: "http://qbittorrent:8080"
      QBT_RULES_QBITTORRENT_USERNAME: "admin"
      QBT_RULES_QBITTORRENT_PASSWORD: "adminpass"

      # Logging
      LOG_LEVEL: "INFO"

    depends_on:
      qbittorrent:
        condition: service_started
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - qbt-network

  redis:
    image: redis:7-alpine
    container_name: qbt-rules-redis
    restart: unless-stopped

    command: redis-server --appendonly yes --appendfsync everysec

    volumes:
      - redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    networks:
      - qbt-network

  # Optional: Scheduled job runner (cron-like)
  # Uncomment to enable automatic rule execution every 5 minutes
  # qbt-rules-cron:
  #   image: ghcr.io/andronics/qbt-rules:latest
  #   container_name: qbt-rules-cron
  #   restart: unless-stopped
  #
  #   volumes:
  #     - ./qbt-rules/config:/config
  #
  #   environment:
  #     QBT_RULES_CLIENT_SERVER_URL: "http://qbt-rules:5000"
  #     QBT_RULES_CLIENT_API_KEY: "your-secure-api-key-here"
  #
  #   command: >
  #     sh -c "while true; do
  #       echo 'Running scheduled rules...';
  #       qbt-rules --context scheduled;
  #       sleep 300;
  #     done"
  #
  #   depends_on:
  #     - qbt-rules
  #
  #   networks:
  #     - qbt-network

networks:
  qbt-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
